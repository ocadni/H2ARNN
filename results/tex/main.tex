\documentclass[aps,physrev,10pt,floatfix,reprint]{revtex4-2}
%\documentclass[preprint, 10pt]{revtex4-2}

\usepackage{graphicx}% Include figure files
\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math
\usepackage{hyperref}% add hypertext capabilities
\usepackage[mathlines]{lineno}% Enable numbering of text and display math
%\linenumbers\relax % Commence numbering lines

\usepackage[%Uncomment any one of the following lines to test 
scale=0.7, marginratio={1:1, 2:3}, ignoreall,% default settings
text={7in,10in},centering,
%%margin=1.5in,
%%total={6.5in,8.75in}, top=1.2in, left=0.9in, includefoot,
%%height=10in,a5paper,hmargin={3cm,0.8in},
]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amstext}
\usepackage{graphicx}
\usepackage{esint}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{amsfonts}
\usepackage{nicefrac}

\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={Overleaf Example},
    pdfpagemode=FullScreen,
    }
%\geometry{verbose,lmargin=2cm,rmargin=2cm}

\begin{document}

%\title{Autoregressive neural network of spins system: the deepness of Mean-Field models}
\title{Autoregressive neural network architecture of the Boltzmann distribution: the cases of pairwise interacting systems and two mean-field models.}
\author{Biazzo, Indaco}
 \altaffiliation[Also at ]{Physics Department, XYZ University.}
 %Lines break automatically or can be forced with \\
\date{\today}

\begin{abstract}
    In recent years, generative neural networks have gained significant attention for both scientific and commercial purposes. Generative Autoregressive Neural Networks (AR-NN), like Transformers, have demonstrated exceptional performance in various image and language generation tasks. This study aims to provide a physical interpretation of AR-NN architectures by reformulating the Boltzmann distribution of a generic pairwise interacting Hamiltonian of binary variables in autoregressive form. The resulting deep AR-NN architecture has weights and biases of the first layer that correspond to the couplings and external fields of the Hamiltonian, respectively, and incorporates commonly used features in computer science literature such as residual connections and recurrent structures, but now with clear physical interpretation. However, a major limitation of these AR-NNs is that one of the hidden layers grows exponentially with system size, making them infeasible for realistic applications. To address this challenge, AR-NN architectures for two iconic mean-field statistical physics systems, namely the Curie-Weiss (CW) and the Sherrington-Kirkpatrick (SK) models, are derived. The exact AR-NN architecture of the CW model is derived for both finite and infinite numbers of variables, resulting in deep architectures with parameters that scale polynomially with system size. An approximate AR-NN architecture for the SK model is derived based on the k-step replica symmetric breaking (k-RSB) ansatz of the Parisi solution, transforming its exponentially large hidden layer into a deep structure, where each step of replica symmetric breaking corresponds to adding a linear layer and a non-linear operator. The number of parameters in this architecture scales polynomially with system size for finite k-RSB, paving the way to apply the Parisi solution of the SK model to single instances problem. The derived architectures are compared with other AR-NN architectures with an equivalent number of parameters for both models, and superior performance is observed over a wide range of physical phase space. This framework provides a means to derive new AR-NN architectures for different interacting systems and interpret existing ones from a physical perspective.
\end{abstract}
    
    %\keywords{Suggested keywords}%Use showkeys class option if keyword
                                  %display desired
    
\maketitle
\tableofcontents
\section{Introduction} 
The cross-fertilization between machine learning and statistical physics, in particular of disorder systems, has a long history \cite{doi:10.1073/pnas.79.8.2554, PhysRevA.32.1007}.
Recently, the development of deep neural network frameworks \cite{bengioNatureDeepLearning2015} have been applied to statistical physics problems \cite{RevModPhys.91.045002} spanning a wide range of domains, including quantum mechanics \cite{doi:10.1126/science.aag2302, Nieuwenburg2017}, 
classical statistical physics \cite{Carrasquilla2017, Wu2019}, chemical and biological physics \cite{noe2019boltzmann,jumper2021highly}, and complex inference problems \cite{Biazzo2022}.
On the other hand, techniques borrowed from statistical physics have been used to shed light on the behavior of Machine Learning algorithms \cite{doi:10.1080/00018732.2016.1211393, Nguyen2017}, and even to suggest training or architecture frameworks \cite{Chaudhari_2019, pmlr-v37-sohl-dickstein15}.
In last years, the introduction of deep generative autoregressive models \cite{pmlr-v37-germain15, NIPS2016_b1301141}, like transformers \cite{NIPS2017_3f5ee243}, has been a breakthrough in the field, generating images and text with a quality comparable to human-generated ones \cite{https://doi.org/10.48550/arxiv.2005.14165}. One of the main advantages of these models is that they can be trained in an unsupervised manner, and they can be used, thanks to ancestral sampling, to generate efficient new independent samples from a given probability distribution. 
The introduction of deep AR-NN was motivated as a flexible and general approach to generating according to a probability distribution learned from data \cite{pmlr-v32-gregor14, pmlr-v15-larochelle11a, pmlr-v48-oord16}. In classical statistical physics, the AR-NN was introduced, in a variational setting, as an improvement over the standard variational approach thanks to the high expressiveness of the AR-NN architecture \cite{Wu2019}, and quickly similar approaches are used in different contexts and domains of classical \cite{10.1103/physreve.101.023304,PhysRevE.101.053312,PhysRevE.103.012103,PhysRevResearch.3.L042024,10.1038/s42256-021-00401-3} and quantum statistical physics \cite{10.1103/physrevlett.128.090501,PhysRevA.102.062413,PhysRevLett.124.020503,PhysRevResearch.2.023358, Liu_2021, Barrett2022}. The ability of the AR-NNs to efficiently generate samples, thanks to the ancestral sampling procedure, opened the way to overcome the slow down of Monte-Carlo methods for frustrated or complex systems, although recently some work questioned the real gain in very frustrated systems \cite{condmat7020038,https://doi.org/10.48550/arxiv.2210.11145}.
%The main idea behind these models is to use a neural network to predict the next element in a sequence given all previous elements. 
A large part of the application of the AR-NN in statistical physics problems apart from small modifications used architecture created for computer science problems, usually constructed for very different purposes. The main difference when we are working with statistical physics problems is that usually the model we want to approximate is known, and the main aim of this work is to show how this information can be used to shape better architecture for the problems under study and using standard statistical physics computations to derive them. In the following, I'll derive the AR-NN architecture of the classical Boltzmann distribution of a general pairwise interacting Hamiltonians of binary variables. Despite the generality of the hamiltonian the architecture displays interesting properties:
\begin{itemize}
    \item The first layer parameters of the network are directly related to the Hamiltonian parameters.
    \item The emergence of residual connections and recurrent structures with a clear physical interpretation.
\end{itemize}
The resulting deep AR-NN architecture has the number of parameters of the second layer scaling exponentially with the system's size. 
However, the physical clear picture of the architecture allows us to use standard statistical physics techniques to find new AR-NN architecture for specific statistical physics systems. To show the potentiality of the representation the AR-NN architectures for two very well-known mean-field models are derived: the Curie-Weiss model (CW) and the Sherrington-Kirkpatrick model (SK). These fully connected models are chosen due to their paradigmatic role in the history of statistical physics systems. The CW model, despite its straightforward hamiltonian, was one of the first models explaining the behavior of ferromagnet systems, displaying a second-order phase transition \cite{kadanoff2000statistical}. In this case, an exact AR-NN architecture both at finite N and in the thermodynamic limit is obtained with the number of parameters scaling polynomially with the system's size.

The SK model \cite{PhysRevLett.35.1792} is a spin glass Mean-Field model of disorder magnetic materials. Once again, despite its simple Hamiltonian, key concept and methods of the celebrated \cite{Nobel2021} replica symmetric breaking solution \cite{PARISI1979203, PhysRevLett.43.1754} of Parisi, has been applied to very different problems, like neural networks \cite{Gardner_1987, PhysRevLett.55.1530}, optimizations \cite{doi:10.1126/science.1073287}, inference problems \cite{doi:10.1080/00018732.2016.1211393}, or in characterizing the jamming of hard spheres \cite{RevModPhys.82.789, PhysRevLett.102.195701}. The complex many valley landscapes of the probability distribution captured by the replica symmetric breaking (RSB) solution is the key concept that unifies the description of many different problems. In the following, I will derive an AR-NN architecture for the Boltzmann distribution of the SK model for a single instance of disorder, with a finite number of variables. The derivation is based on the RSB solution, where a deep AR-NN architecture with parameters scaling polynomially with the system size is derived. \\
Where?
\cite{Carleo2018},
similar approach for density estimation with energy function, where they arrive an approximated ARNN with peculiarities similar to my approach \cite{pmlr-v80-huang18d}.
            
\section{autoregressive Boltzmann distribution of pair-wise interacting Hamiltonian}

The Boltzmann probability distribution of a given Hamiltonian $H[\mathbf{x}]$ of a set of $N$ binary variables $\mathbf{x}=\{x_1, x_2,...x_N\}$ at inverse temperature $\beta$ is $P(\mathbf{x}) = \nicefrac{e^{-\beta H\left(\mathbf{x}\right)}}{Z}$. The $Z=\sum_{\mathbf{x}}e^{-\beta H\left(\mathbf{x}\right)}$ is the usually normalization factor.
It is generally challenging to compute marginals and average quantities when $N$ is large, and generate samples on frustrated systems. Defining the sets of variables $\mathbf{x}_{<i}=\left(x_{1},x_{2}\dots x_{i-1}\right)$ and $\mathbf{x}_{>i}=\left(x_{i+1},x_{i+2}\dots x_{N}\right)$ respectively with an index lower and larger than $i$, then if we can rewrite the Boltzmann distribution in the autoregressive form:
$
P\left(\mathbf{x}\right)=\prod_{i}P\left(x_{i}|\mathbf{x}_{<i}\right),
$
it would be straightforward to produce independent samples from it, thanks to the ancestral sampling procedure \cite{Wu2019}. It has been proposed \cite{Wu2019} to use a variational approach to approximate the Boltzmann distribution with trial autoregressive probability distributions where each conditional probability is represented by a feed-forward neural network with a set of parameters ${\theta}$,
$
Q^{\theta}\left(\mathbf{x}\right)=\prod_{i}Q^{\theta_i}\left(x_{i}|\mathbf{x}_{<i}\right)
$.
The parameters ${\theta}$ can be learn minimizing the (inverse) Kullback-Leibler divergence $D_{KL}$,
with the true probability function:
\begin{equation}
\begin{split}
& D_{KL}\left(P|Q^{\Theta}\right) =  \sum_{\left\{ x\right\} }Q^{\Theta}\left(\mathbf{x} \right)\ln\left(\frac{Q^{\Theta}\left(\mathbf{x} \right)}{P\left(\mathbf{x} \right)}\right)  \\
& \approx \sum_{\mathbf{x}\sim Q^{\Theta}}\left[\ln\left(Q^{\Theta}\left(\mathbf{x} \right)\right)-\ln\left(P\left(\mathbf{x} \right)\right)\right]
\end{split}    
\end{equation}
Thanks to the ancestral sampling, we substituted the sum over all possible configurations with a subset of configurations extracted from the autoregressive trial functions, and usually, an annealing procedure is applied, starting from high temperature and slowly decreasing it.
In this framework, the choice of the architecture of the neural networks is crucial to obtain a good approximation of the Boltzmann distribution.

\subsection{Conditionals}
The generic $i$-th conditional probability factor of the Boltzmann can be rewritten in this form: 
\begin{equation}
    \label{eq:chain}
    \begin{split}
    & P\left(x_{i}|\mathbf{x}_{<i}\right)  = 
    \frac{P\left(\mathbf{x}_{<i+1}\right)}{P\left(\mathbf{x}_{<i}\right)}  = 
    \frac{\sum_{\mathbf{x}_{>i}}P\left(\mathbf{x}\right)}{\sum_{\mathbf{x}_{>i-1}}P\left(\mathbf{x}\right)} \\
    &=\frac{\sum_{\mathbf{x}_{>i}}e^{-\beta H}}{\sum_{\mathbf{x}_{>i-1}}e^{-\beta H}}  = 
    \frac{f\left(x_{i},\mathbf{x}_{<i}\right)}{\sum_{x_{i}}f\left(x_{i},\mathbf{x}_{<i}\right)}.
    \end{split}
\end{equation}
where I defined: $f\left(x_{i}=\pm 1,\mathbf{x}_{<i}\right) = \sum_{x_{i+1}\dots x_{N}}e^{-\beta H}\delta_{x_i, \pm1}$, and $\delta_{a,b}$ is the delta di Kronecker function that is one when the two values $(a,b)$ coincides and zero otherwise. Usually, in the representation of the conditional probability $P\left(x_{i}=1|\mathbf{x}_{<i}\right)$ as a feed-forward neural network, the set of variable $\mathbf{x}_{<i}$ is the input, and the sigma function $\sigma(x)=\frac{1}{1+e^{-x}}$ is the last layer, assuring that the output is between $0$ and $1$. The probability $P\left(x_{i}=-1|\mathbf{x}_{<i}\right) = 1 - P\left(x_{i}=1|\mathbf{x}_{<i}\right)$ is straightforward to obtain. With simple algebraic manipulations, we can write: 
\begin{equation}
    \label{eq:sigma_log}
    \begin{split}
    & P\left(x_{i}=1|\mathbf{x}_{<i}\right) = \frac{f\left(1,\mathbf{x}_{<i}\right)}{\sum_{x_{i}}f\left(x_{i},\mathbf{x}_{<i}\right)}\\
    &= \sigma\left(\log\left[f\left(1,\mathbf{x}_{<i}\right)\right]-\log\left[f\left(-1,\mathbf{x}_{<i}\right)\right]\right)
    \end{split}
\end{equation}
Consider a generic two-body interaction Hamiltonian of binary spin variables $x_i \in \{-1,1\}$, $H = -\sum_{i<j} J_{ij} x_i x_j - \sum_{i} h_i x_i$, where $J_{ij}$ are the interaction couplings and $h_i$ are the external fields. Substituting it in eq.\ref{eq:sigma_log}, we obtain:
\begin{figure}[!ht]
    %\centering 
    \includegraphics[width=0.45\textwidth]{img/h2ARNN.pdf}
    \caption{Neural network Architectures of conditional probability}
    \label{fig:arch}
\end{figure}
\begin{equation}
    \label{eq:conditional_ghann}
    \begin{split}
    & P\left(x_{i}=1|\mathbf{x}_{<i}\right) = \\
    & \sigma\left( 2 \beta \left(h_i + \sum_{s=1}^{i-1} J_{si} x_s\right) +\log(\rho_i^+) - \log(\rho_i^-)
    \right),   
    \end{split}
\end{equation}
where:
\begin{equation}
    \begin{split}
    \rho_i^{\pm}&[\mathbf{x}_{<i}]  = \sum_{\mathbf{x}_{>i}}  \exp \bigg(
    \beta\sum_{l=i+1}^{N} x_l \sum_{s=1}^{i-1} J_{sl} x_s +\\
    &\beta\sum_{l=i+1}^{N}\big( \pm J_{il}  + h_l \big) x_l 
    + \beta\sum_{l=i+1}^{N}\sum_{l'=l+1}^{N} J_{ll'} x_l x_{l'} \bigg)
\end{split}
\label{eq:rho_ghann}
\end{equation}
The elements in $H$ that depend only on $\mathbf{x}_{<i}$, $\sum_{s=1}^{i-1} h_s x_s + \sum_{s=1}^{i-1}\sum_{s'=s+1}^{i-1} J_{ss'} x_{s} x_{s'}$, cancel out.
The conditional probability, eq.\ref{eq:conditional_ghann}, can be interpreted as a feed-forward neural network, with the following architecture (see fig.\ref{fig:arch}) :
%\begin{equation}
\begin{multline}
        P_i\left(x_i=1 | \mathbf{x}_{<i}\right) = 
     \sigma \bigg\{ x_i^1+ 
     \log\big[ \sum_{c} e^{b_c^+ + \sum_{l=i+1}^{N} w_{cl} x_{il}^1}\big]\\
     +\log\big[ \sum_{c} e^{b_c^- + \sum_{l=i+1}^{N} w_{cl} x_{il}^1}\big] \bigg\},
\end{multline}
%\end{equation}
where $x_i^1=\sum_{s=1}^{i-1} J_{si} x_s$ and $x_{il}^1=\sum_{s=1}^{i-1} J_{sl} x_s$ are the output of the first layer. 
Then, a second layer acts on the set of $x_{il}^1$ (see fig.\ref{fig:arch}). The $\sum_{c}$ is over the $2^{N-i}$ number of configurations of the set of $\mathbf{x}_{>i}$ variables. 
The parameters of the second layers are the $b_c^{\pm} = \beta\sum_{l=i+1}^N (\pm J_{il} + h_l + \sum_{l'=l+1}^N J_{ll'}x_{l'}) x_l $ and the $w_{cl}=x_l$, where $c$ is the index of the configuration of the set of $\mathbf{x}_{>i}$ variables. Then, the two functions $\rho^{\pm}$ are obtained by applying the non-linear operator $\log \Sigma \exp (\mathbf{x}) = \log(\sum_i e^{x_i})$ at the output of the second layer (see fig.\ref{fig:arch}). 
As the last layer, the two $\rho^{\pm}$ and $x_i^1$ are combined with the right signs, and the sigma function is applied. The whole architecture of the Boltzmann distribution of general pairwise interacting Hamiltonian of an Autoregressive Neural Network ($\text{H}_2\text{ARNN}$) is depicted in fig.\ref{fig:arch}. The total number of parameters scales exponentially with the system size, making the sampling infeasible after a few spins.
Nevertheless, the $\text{H}_2\text{ARNN}$ architecture shows some interesting futures:
\begin{itemize}
    \item The weights and biases of the first layers are the parameters of the Hamiltonian of the Boltzmann distribution.  As far as the author knows, it is the first time that a neural network architecture is proposed to represent the autoregressive Boltzmann probability distribution of a classical physical system where the weights and biases of the first layers are the parameters of the Hamiltonian. 
    \item Residual connections among layers, due to the $x_i^1$ variables, naturally emerge from the derivation. 
    The importance of residual connections appeared recently \cite{10.48550/arxiv.1512.03385}, and became a key element in the success of the ResNet and transformer architectures \cite{vaswani2017attention}, in classification and generative tasks. They were presented as a way to improve the training of deep neural networks avoiding the exploding and vanishing gradient problem. In our context, they represent the direct interactions among the variable $x_i$ and all the previous variables $\mathbf{x}_{<i}$. 

    \item The $\text{H}_2\text{ARNN}$ is a recurrent neural network \cite{bengioNatureDeepLearning2015, https://doi.org/10.48550/arxiv.1506.00019}, similar to some AR-NN architecture used in statistical physics problems \cite{10.1038/s42256-021-00401-3, PhysRevResearch.2.023358}. 
    The first layer, see figure \ref{fig:arch}, is composed of the following set of linear operators on the input $x^1_{il}(\mathbf{x}_{<i})=\sum_{s=1}^{i-1} J_{si} x_s$ with $i<l<=N$. The set of $x_{il}$ can be rewritten in recursive form observing that:
    \begin{equation}
        x^1_{il} = x^1_{i-1,l} + J_{i-1,l} x_{i-1}
    \end{equation}
    The neurons $x^1_{il}$ in the first layer of each conditional probability in the $\text{H}_2\text{ARNN}$ architecture depend on the $x^1_{i-1,l}$ of the previous conditional probability.
\end{itemize}
%This dependence on the size of the system appears reasonable because, otherwise, it could be possible to sample to whatever pairwise hamiltonian in polynomial time, and as long we assume that $P\neq NP$ it could not be possible. 
%The computational cost of the sum over all the configuration of spins $x_l$ grows exponentially with the system's size making it unfeasible, after a few spins, the explicit computations. The idea is to find feed-forward neural network architectures representing these functions with a polynomial number of free parameters. \\
The number of parameters of the feed-forward neural network representations of the $\rho_i^{\pm}$ functions of the conditional probability of the variable $i$, eq.\ref{eq:rho_ghann}, scale exponentially with the system's size, proportionally to $2^{N-i}$. 
The functions $\rho_i^{\pm}$ take into account the effect of the interactions among $\mathbf{x}_{<i}$ and $\mathbf{x}_{>i}$ on the variable $x_i$. 
The $\rho_i^{\pm}$ function can be interpreted as the partition function of a system, where the variables are the $\mathbf{x}_{>i}$ and the external fields are determined by the values of the variables $x_{<i}$.
Starting from that observation, in the following, I will show how to use standard tools of statistical physics to derive deep AR-NN architecture that solves the exponential growth.  \\

\section{Models}
\subsection{The Curie-Weiss model}

The Curie-Weiss model (CW) is a uniform, fully-connected Ising model. The Hamiltonian, with $N$ spins, is $H\left(\mathbf{x}\right)=-h\sum_{i=1}^{N}x_{i}-\frac{J}{N}\sum_{i<j}x_{i}x_{j}$. The conditional probability of a spin $i$, eq.\ref{eq:conditional_ghann}, of the CW model is:
\begin{multline}
P^{CW}\left(x_{i}=1|\mathbf{x}_{<i}\right) = 
\sigma\bigg( 
 2 \beta h + 2 \beta \frac{J}{N}\sum_{s=1}^{i-1}x_{s} + \\
 \log(\rho_i^+[\mathbf{x}_{<i}]) - \log(\rho_i^-[\mathbf{x}_{<i}])
\bigg),
\label{eq:conditional_cw}
\end{multline}
where:
\begin{equation}
\rho_i^{\pm}[\mathbf{x}_{<i}] \propto \sum_{\mathbf{x}_{>i}}e^{\beta \left(h\pm\frac{J}{N}+\frac{J}{N}\sum_{s=1}^{i-1}x_{s}\right)\sum_{l=i+1}^{N}x_{l}+\frac{\beta J}{2N}(\sum_{l=i+1}^{N}x_{l})^{2}} 
%\sum_{x_{i+1}\dots x_{N}} e^{\beta h_i^{\pm}[\mathbf{x}_{<i}]S_i +\frac{\beta J}{2N}S_{i}^{2}},
\label{eq:rho_cw_0}
\end{equation}
Defining $h_i^{\pm}[\mathbf{x}_{<i}] =h\pm\frac{J}{N}+\frac{J}{N}\sum_{s=1}^{i-1}x_{s}$, at given $\mathbf{x}_{<i}$, the eq. \ref{eq:rho_cw_0} is equivalent to the partition function of a CW model, with $N-i$ spins and external fields $h_i^{\pm}$. 
As shown in the Appendix, the summations over $\mathbf{x_{i>}}$ can be easily done, finding the following expression:

 \begin{eqnarray*}
 \rho_i^{\pm}[\mathbf{x}_{<i}] = \sum_{k=0}^{N-i} e^{a_{i,k}^{\pm} + b_{i,k}^{\pm} \sum_s x_s} 
\end{eqnarray*}
where we defined:
\begin{align}
\label{eq:params}
\begin{split}
b_{i,k}^{\pm} & = \log\left(\binom{N-i}{k}\right) + \frac{\beta J}{2N}\left(N-i-2k\right)^{2}+ \\
& \qquad \left(N-i-2k\right)\left(\beta h \pm \frac{\beta J}{N}\right)
\end{split} \\
\omega_{i,k}^{\pm} & = \frac{\beta J}{N}\left(N-i-2k\right).
\label{eq:CW_params}
\end{align}
The final feed-forward architecture of the Curie-Weiss Autoregressive Neural Network (CW-ARNN) architecture is:
\begin{multline*}
%\label{eq:curie_weiss_cond}
P^{CW}\left(x_{i}=+1|\mathbf{x}_{<i}\right)  =   \sigma \bigg[b_{0}+\omega_{0}\sum_{s=1}^{i-1}x_{s}\\
-\log\big(\sum_{k=0}^{N-i}e^{b_{i,k}^{+} + 
w_{i,k}^{+}\sum_{s=1}^{i-1}x_{s}}\big)+\log\big(\sum_{k=0}^{N-i}e^{b_{i,k}^{-} + w_{i,k}^{-}\sum_{s=1}^{i-1}x_{s}}\big)\bigg],
\end{multline*}
where $b^0=2\beta h$, $\omega^0_i = \frac{2\beta J}{N}$ are the same, and so shared, among all the conditional probability functions, see fig.\ref{fig:CW_arch }. Their parameters have an analytic dependence from the parameters $J$ and $h$ of the Hamiltonian of the systems. 
%The set of parameters ($b_i, b_i^{k\pm}, \omega_i, \omega_i^{k\pm}$) can be consider as free parameters trained to minimize the KL divergence with the true probability distribution. 
\begin{figure}[!h]
    \centering 
    \includegraphics[width=0.5\textwidth]{img/CW_arch.pdf}
    \caption{Neural network Architectures of the conditional probability of the CW model.}
    \label{fig:CW_arch}
\end{figure}

It is interesting to note the number of parameters of the CW-ARNN is $2+4(N-i)$; they decrease as $i$ increases. This result is, somehow, the opposite of what the neural network architecture usually should take care of, meaning increasing the number of input variables, the number of parameters should also increase to describe the complexity of the function. Still, it is compatible with what was derived for the general case, where the number of parameters needed for the $\rho^{\pm}$ decreases, in that case exponentially, with the index $i$. The CW-ARNN depends only on the sum of the input variables.
The total number of parameters of whole conditional probability distribution scales as $2N^2+ O(N)$. \\
If we consider the thermodynamical limit, $N \gg 1$, the architecture of the CW model, $\text{CW}_{\infty}$, simplify:
\begin{equation*}
    %\label{eq:curie_weiss_cond2}
    P^{CW_{\infty}}\left(x_{i}=1|\mathbf{x}_{<i}\right) =  \sigma \left(b^0+\omega_{i}^0\sum_{s=1}^{i-1}x_{s} + \omega_i^1 \text{sgn}(\sum_{s=1}^{i-1}x_{s})\right).
\end{equation*}
where $b^0=2\beta h$, $\omega^0_i = \frac{2\beta J}{N}$ are the same, and so shared, among all the conditional probability functions. The $\omega^1_i = -2\beta J |m_i|$ is different for each of them, and $m_i$ is the solution of the following equation:
\begin{equation}
    \frac{m_i N}{N-1} = \tanh \left( \beta(\frac{m_i N}{N - i} - \frac{m_{\beta}N}{N-i}) \right)
    \label{eq:extrem_i}
    \end{equation}
where $m_{\beta}$ is the average magnetization of the CW systems at inverse temperature $\beta$, see Appendix for details. In practice the set of $\omega^1_i$ are treated as variational parameters to be learned during the training. The total number of parameters of the $\text{CuWANN}_{\infty}$ scale as $N+2$.
    

\subsection{The Sherrington-Kirkpatrick model}
The SK hamiltonian, with zero external fields for simplicity, is given by:
\begin{equation}
H\left(\mathbf{x}\right)=-\sum_{i<j}J_{ij}x_{i}x_{j}
\end{equation}
where the set of $\underline{J}$ are i.i.d. random variable extracted from a Gaussian probability distribution $P(J)=\sqrt{\frac{N}{2\pi}}\exp\left(\frac{-NJ^2}{2} \right)$. \\
To find a feed-forward representation of conditional probability of its Boltzmann distribution, we use the replica trick \cite{10.1142/0271} that, usually, is applied together with the average over the system's disorder. In our case, we work on a single instance of the set of $Js$, but I will assume that $N-i$ is large enough such that the following approximation hold for the $\rho_i^{\pm}$ functions: 
\[
\log\rho_i^{\pm} \sim \mathbb{E}\left[  \log\rho_i^{\pm} \right] = \lim_{n\rightarrow 0} \frac{  \log(\mathbb{E}\left[(\rho_i^{\pm})^n \right])}{n}
\]
In the last equality, we use the replica trick. 
For each specific conditional probability, the average over the disorder $\mathbb{E}$ is taken on the coupling parameters $J_{ll'}$ with $l,l'>i$. Implicitly, we assume that the quantities $\log\rho_i^{\pm}$ are a self-averaged quantity on the $\mathbf{x}_{i>}$ variables.
 The replica computation can be carried on easily, finding:
\begin{multline}
\mathbb{E}_{\underline{J}}\left[(\rho_i^{\pm}[\mathbf{x}_{<i}])^n \right]  = 
\int \prod_{l<l'} dP_{J_{ll'}} \bigg\{ 
\sum_{\{\underline{x}^{a}\}_{i+1}^N} \exp\bigg[\\ \beta \bigg( 
\sum_{l,a}\bigg( \pm J_{il}  
+ \sum_{s} J_{sl} x_s \bigg) x_l^{a} + 
\sum_{l,l', a} J_{ll'} x_l^{a} x_{l'}^{a}
\bigg)  \bigg] 
\bigg\}
\end{multline}
where, the sums over $(l,l')$, $s$ and $a$ run respectively over $(i+1,N)$, $(1,i-1)$ and $(1,n)$, and $dP_{J_{ll'}}=P(J_{ll'})dJ_{ll'}$. Defining $h_l^{\pm}[\mathbf{x}_{<i}] =\pm J_{il} + \sum_{s=1}^{i-1} J_{sl} x_s$ as an external field, we can observe that the above quantity is the partition function a classical SK model with external fields $h_l^{\pm}[\mathbf{x}_{<i}]$, at fixed $\mathbf{x}_{<i}$ and $J_{ll'}$ as coupling constants of the variables $\mathbf{x}_{i>}$.  
Computing the integrals over the disorder we find: 
\begin{widetext}
\begin{align}
\mathbb{E}_{\underline{J}}\left[(\rho_i^{\pm}[\mathbf{x}_{<i}])^n \right]
& \propto  
\sum_{\{\underline{x}^{a}\}_{i+1}^N} 
\exp\left\{\beta \left[
\sum_{l} h_l^{\pm}[\mathbf{x}_{<i}] \sum_{a} x_l^{a} +\frac{\beta}{2N} \sum_{a<b} \left( \sum_{l}  x_l^{a} x_l^{b} \right)^2 \right]  \right\}\\
& \propto  \int \prod_{a<b} dQ_{ab} e^{-\frac{N}{2}\beta^2Q_{a,b}^2}
\prod_{l} \left[
\sum_{\{\underline{x}^{a}_l\}} 
\exp\left\{\beta \left[
h_l^{\pm}[\mathbf{x}_{<i}] \sum_{a} x_l^{a} +\beta \sum_{a<b} Q_{a,b}  x_l^{a} x_l^{b} \right]  \right\}
\right]
\end{align}
\end{widetext}
where in the last line we used the Hubbard-Stratonovich transformation to linearize the quadratic terms. 
The Parisi solutions of the SK model prescribe how to parametrize the matrix of the overlaps $\{Q_{a,b}\}$ \cite{10.1142/0271}. The easiest way to parametrize the overlaps is the replica symmetric solutions (RS), where the overlaps are symmetric under permutations: 
$$
Q_{a,b}=\begin{cases}
			0, & \text{if $a=b$}\\
            q, & \text{otherwise}
		 \end{cases},
$$
Then a sequence of better approximations can be obtained by breaking, by step, the replica symmetry, from the 1-step replica symmetric breaking (1-RSB) to the infinite limit of the k-step replica symmetric breaking (k-RSB) solutions. 
The sequence k-RSB approximations can be seen as nested non-linear operations \cite{Parisi_1980}, see Appendix for details. 
\begin{figure}[!h]
    \centering 
    \includegraphics[width=0.5\textwidth]{img/SK_arch.pdf}
    \caption{Neural network Architectures of the conditional probability of the SK model.}
    \label{fig:SK_arch}
\end{figure}

Every k-step replica symmetric breaking solution leads to adding a gaussian integral and two more free variational parameters to the solutions of the $\rho^{\pm}$ functions. 
In the following, we will use a feed-forward representation that enlarges the space of parameters, using a more computationally friendly non-linear operator. 
Numerical evidence of the goodness of the approximation used is shown in the Appendix. 
Overall, the parametrization of the overlaps matrix allows to perform the sum over all the configuration of the variables $\mathbf{x}_{i>}$ getting rid of the exponential scaling with the system's size of the number of parameters. 
The final AR-NN architecture of the SK model $\text{SK-ARNN}$ is: 
\begin{multline}
    Q^{\text{RS/k-RSB}}\left(x_{i}=1|\mathbf{x}_{<i}\right) = \sigma\bigg( 
        x_i^1(\mathbf{x}_{<i}) \\
        +\log(\rho_i^{+, \text{(RS/kRSB)}}) -
         \log(\rho_i^{-, \text{(RS/kRSB)}})
    \bigg)  
\end{multline}
Where for RS and 1-RSB cases the architectures are:
\begin{align*}
    \log \rho^{\pm, RS} & = \sum_{l^{\pm}=i+1}^{N}  w_0^{i,l^+} \log \sigma(b_1^{i,l^{\pm}} +
w_1^{i,l^{\pm}} x_{i,l^{\pm}}^1(\mathbf{x}_{<i})) \\
\begin{split}
    \log \rho^{\pm, 1RSB} & = 
    \sum_{l^{\pm}=i+1}^{N}  w_0^{i,l^{\pm}} \log\sigma(b_1^{i,l^{\pm}} + \\
    &  w_1^{i,l^{\pm}} \log\sigma(b_2^{i,l^{\pm}} +  w_2^{i,l^{\pm}}  x_{i,l^{\pm}}^1(\mathbf{x}_{<i}))) 
    \end{split}
\end{align*}
Where $x_{i,l^{\pm}}^1(\mathbf{x}_{<i})$ is the output of the first layer of the AR-NN, see eq. , and $(w_0^{i,l^{\pm}}, b_1^{i,l^{\pm}}, w_1^{i,l^{\pm}}, b_2^{i,l^{\pm}}, w_2^{i,l^{\pm}})$ are the free variational parameters of the AR-NN, see fig.\ref{fig:SK_arch}. The number of parameters of a single conditional probability distribution scales as $2(k+1)(N-i)$ where $k$ is the level of the k-RSB solution used, assuming $k=0$ as the RS solution.

\section{Results}

\begin{figure}[!h]
    \centering
    \includegraphics[width=0.45\textwidth]{img/CW_res.pdf}
    \caption{Results}
    \label{fig:curie_weiss}
\end{figure}

In this section, the results of comparisons between generative neural network architectures in learning the SK and CW models are shown. 
%Moreover, the ability to recover the hamiltonian coupling parameters from Monte-Carlo-generated instances is presented. 
The $CW$, $CW_{\infty}$ and $SK_{RS/k-RSB}$ architecture, are compared with: a single variable net, $1Par$, where, for each conditional probability a single weight parameter is applied to the sums of the input variable, and then the sigma function is applied. This architecture was already used, for the CW system in \cite{https://doi.org/10.48550/arxiv.2210.11145}. Then the Single Layer (SL) architecture, where a fully connected single linear layer parametrizes the whole probability distribution, where a mask is applied to a subset of the weights in order to preserve the autoregressive properties. The width of the layer is $N$, and the total number of parameters scale as $N^2$. Finally, I consider the MADE architecture \cite{pmlr-v37-germain15}, an extension to deep neural networks of the SL architecture. In this case, the whole probability distribution is represented with a deep sequence of fully connected layers, with non-linear activation functions and masks in between them, to assure the autoregressive properties and enhance the expressive power. The MADE$_{dw}$ used has $d$ number of hidden layers, each of them with width $w$ times the number of input variable $N$. For instance, the SL architecture is equivalent to the MADE$_{11}$ and MADE$_{23}$ has two hidden fully-connected layers, each of them of width $3*N$. 
The ARR-NN framework presented is a variational approach and in general, the variational free energy $F^{Q} =  \sum_{\mathbf{x}} Q^{\theta}(\mathbf{x})(\beta E(\mathbf{x}) + \log(Q^{\theta}(\mathbf{x}))) > F$ is an upper bound of the true one. In our case, the sum over all the configurations in the computation of the variational free energy is substituted by an estimation of the variational free energy with 20K number of configurations sampled from the autoregressive neural network.
In the following, I utilized the same training procedure, unless conversely specified; starting from $\beta=0.1$ it reached $\beta=2.0$ with a step of $0.05$. The training was performed with a batch size of $2000$ samples and $1000$ epochs for each temperature, with a learning rate of $0.001$, and the ADAM algorithm was used for the optimization of the AR-NN parameters. 
The first layers of $CW_{\infty}$ and $SK_{RS/k-RSB}$ are fixed by the hamiltonian parameters, and for the $CW$ all the parameters are fixed and pre-calculated, see eq.\ref{eq:CW_params}.\\
The results on the CW model, with $J=1$ and $h=0$, are shown in fig.\ref{fig:curie_weiss}. 
The plots A1, A2, and A3, in the first row, show the relative error of the free energy, with respect to the exact one computed analytically, for different system sizes $N$. 
The free energy computed from samples generated with CW architecture does not have an appreciable difference with the analytic solution, and the CW$_{\infty}$ improves as the system size increases. In fig.\ref{fig:curie_weiss}.B plots the error in the free energy estimation for the architectures with fewer parameters as function of $N$, 1Par and CW$_{\infty}$ (both scaling linearly with the system's size and differing only by one parameter); It shows clearly that a deep architecture, in this case with only one more parameter, improves of orders of magnitude the accuracy. The need for deep architectures, already on a simple model as the CW, is indicated by the worst performance of the SL net, where despite the scaling of parameters as $N^2$, the performances are similar to the 1Par architecture. The MADE architecture obtains good results but was not close to the $CW$, even though having higher numbers of parameters. The plot in fig.\ref{fig:curie_weiss}(c) shows the distribution of the overlaps $q_{\mathbf{a}, \mathbf{b}}=\sum_{i} a_i b_i$ of the samples generated by the AR-NN architecture. The distribution is computed at $\beta=1.3$ for $N=200$. It can be seen as the worst performance of the 1-layer networks (1par, SL) is due to the difficulty of correctly representing the configurations with magnetization different than zero in the proximity of the phase transition. This could be due to some mode collapse problems \cite{https://doi.org/10.48550/arxiv.2210.11145}, which does not afflict the other deep AR-NN architectures tested.

\begin{figure}[]
    \centering 
    \includegraphics[width=0.48\textwidth]{img/SK_res.pdf}
    \caption{Results}
    \label{fig:SK}
\end{figure}

In figure \ref{fig:SK}, the result of the SK model, with $J=1$ and $h=0$ are shown; as before in the first row there is the relative error in the estimation of the free energy at different system sizes. In this case, the exact solution, for a single instance of disorder and a finite $N$ is not known. In this case, I take the free energy estimation of the SK-ANN$_{2-RSB}$ as a reference and compute the relative difference from it. The free energy estimated of SK-ANN$_{k-RSB}$ with $k=1,2$ are very close to each other, confirming the fact that the difference in free energy is very small from the 1-RSB all the subsequent k-RSB solutions \cite{Parisi_1980}. The performance KS-ARNN$_{RS}$ net is the same as the SL architecture even with a much higher number of parameters. The MADE architecture tested, even with a similar number of parameters of the SK-ANN$_{k-RSB}$ net, estimate a smaller free energy, with the difference increasing with $N$. Observing the overlap distribution in the glassy phase of the sample generated by the architecture, fig.\ref{fig:SK}.D we can check as the distribution generated by the ANN$_{k-RSB}$ is higher in the region between the pick and zero overlaps, testifying that these architectures better capture the complex landscape of probability distribution \cite{PhysRevLett.51.1206}.

\begin{figure}[]
    \centering 
    \includegraphics[width=0.45\textwidth]{img/MC_img.pdf}
    \caption{Results}
    \label{fig:SK_MC}
\end{figure}

The last question that the present work aims to answer is: the architecture derived for SK can recover at least approximately the coupling of the hamiltonian of the systems given only samples extracted directly from an instance of disorder of the Boltzmann distribution of the SK model? 10K samples are generated with the Metropolis Monte Carlo algorithm and the SK-ARNN$_{1-RSB}$ is trained to minimize the log-likelihood computed on the samples. As shown in the derivations of the SK-ARNN$_{1-RSB}$ architecture the widths of the first layer of the neural network should be the coupling parameters of the hamiltonian. In fig.\ref{fig:SK_MC} the weights of the first layers are plotted against the coupling hamiltonian finding a good correlation between them. This is also surprising considering its over-parametrization setting: the number of parameters of the neural network, $\sim 60$K, is much higher than the number of samples $10$K.

\section{Conclusions}
In this work, the exact ARNN (H$_2$-ARNN) architecture of a pairwise interacting system hamiltonian was derived. The H$_2$-ARNN is a deep architecture with weight and bias of the first layer respectively equal to the coupling and external field of Hamiltonian. A recurrent structure and skip-connections naturally emerge from the derivation, now with a clear physical meaning. The H$_2$-ARNN is not directly usable due to the exponential explosion with the system's size of the number of parameters of the hidden layers. Nevertheless, the clear physics interpretation allows using statistical physics technics to derive tractable architectures on specific problems, For instance, I showed how to derive the architectures, having the number of parameters that scaling polynomially with the system's size, for the CW and SK models. In the SK case, the derivation was based on the sequence of better approximation k-step Replica symmetric Breaking solution of Parisi, a sequence of better approximation of the true solution that, in this case, was mapped to a sequence of deeper AR-NN architectures. 

The architecture was tested on the Curie-Weiss and the SK model, and the results show that the AR-NN architecture is able to reproduce the free energy of the system better than the standard architectures used in the literature. 
The strong link between the physics of the problems and the neural network architecture was also used in the opposite direction, whereas fig shown, an SK architecture was trained on samples generated according to an SK model, and the weights of the first layer were found to be correlated with the coupling parameters of the hamiltonian.

In general, the derivation of simpler and smaller architecture is not always possible on all kinds of pairwise interactions, and exact solvable physical systems are very few. Nevertheless, the clear physical interpretation allows guiding to derive approximate architectures for specific Boltzmann distributions. Although the architecture of a SK model could be derived, in this work it was not analyzed systematically if then their parameters were learnable. For instance, it is known that finding the configurations of minima energy of the SK model belongs to the class on NP-HARD problems, and it is not clear if such approach was really able to find the correct solutions, and debate is still open \cite{}. 
If the derivation of the ARNN architecture was presented for pairwise interacting systems, could be interesting in future work to check several extensions. For instance, the derivation of the architecture for more state variables, like potts models, where each variable could have more that wo possible values. This could be interesting also because, for instance, the language generative models, like recent transformers architecture, have this structure. Moreover also going further considering more than pairwise interactions, to describe possible more complex probability distribution. Another extension was to check the not fully connected models, but sparse ones, like systems that interact on a grid on a random sparse graph. The first one is fundamental models for a large number of physics systems and also for generating image process. On the other hand, random sparse interacting systems, like the Erdos-Renyi graphs, are common in a large set of optimization or inference problems.  
%\section{Appendix}
%\include{appendix}

\bibliography{refs}% Produces the bibliography via BibTeX.

\end{document}
  